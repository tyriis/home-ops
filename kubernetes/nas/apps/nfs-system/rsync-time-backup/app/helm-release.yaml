---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app rsync-time-backup
spec:
  interval: 30m
  timeout: 5m
  chart:
    spec:
      chart: app-template
      version: 4.6.2
      sourceRef:
        kind: HelmRepository
        name: bjw-s-charts
        namespace: flux-system
  install:
    remediation:
      retries: -1
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    # https://filebrowserquantum.com/en/docs/
    controllers:
      *app :
        type: cronjob
        cronjob:
          concurrencyPolicy: Forbid
          schedule: "0 3 * * *" # daily at 3am
        initContainers:
          fix-permissions:
            image:
              repository: busybox
              tag: latest@sha256:e226d6308690dbe282443c8c7e57365c96b5228f0fe7f40731b5d84d37a06839
            command:
              - sh
              - -c
              - |
                if [ -d "/target" ]; then
                  current_owner=$(stat -c "%u:%g" "/target")
                  if [ "$current_owner" != "1000:1000" ]; then
                    echo "Changing ownership of /target from $current_owner to 1000:1000"
                    chown 1000:1000 "/target" ; touch "/target/backup.marker"
                  else
                    echo "Skipping /target - already owned by 1000:1000"
                  fi
                fi
        containers:
          app:
            image:
              repository: harbor.techtales.io/main/rsync-time-backup
              tag: 25.12.4@sha256:e978f858773137aa71027901ca6c86e0059d215f11041172c32606517f7a0f09
            securityContext:
              allowPrivilegeEscalation: false
              capabilities:
                drop:
                  - ALL
              readOnlyRootFilesystem: false
              runAsUser: 1000
              runAsGroup: 1000
    defaultPodOptions:
      securityContext:
        fsGroup: 1000
        fsGroupChangePolicy: OnRootMismatch
        seccompProfile:
          type: RuntimeDefault
      nodeSelector:
        kubernetes.io/hostname: nas01

    persistence:
      target:
        existingClaim: backup
        globalMounts:
          - path: /target
      public:
        type: nfs
        server: nas02
        path: /public
        advancedMounts:
          *app :
            app:
              - path: /source/public
      fotos:
        type: nfs
        server: nas02
        path: /fotos
        advancedMounts:
          *app :
            app:
              - path: /source/fotos
      home:
        type: nfs
        server: nas02
        path: /home
        advancedMounts:
          *app :
            app:
              - path: /source/home
      syncthing:
        type: nfs
        server: nas02
        path: /syncthing
        advancedMounts:
          *app :
            app:
              - path: /source/syncthing

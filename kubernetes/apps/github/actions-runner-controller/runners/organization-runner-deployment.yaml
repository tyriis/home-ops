---
# https://github.com/actions-runner-controller/actions-runner-controller
apiVersion: actions.summerwind.dev/v1alpha1
kind: RunnerDeployment
metadata:
  name: ${SECRET_GH_ORGANIZATION}-runner
spec:
  # replicas: 1
  template:
    spec:
      image: ghcr.io/actions/actions-runner-controller/actions-runner:v2.299.1-ubuntu-20.04@sha256:69e3b023ecdb34313935952c4375a75414db79f177353123c774290028b3bb3a
      dockerdWithinRunnerContainer: false
      ephemeral: true
      containers:
        - name: docker
          image: docker:24.0.2-dind@sha256:3082f3db41163b823d306f15ce4fe032d56c72c90ef377f67eb0375a552a7131
      organization: ${SECRET_GH_ORGANIZATION}
      githubAPICredentialsFrom:
        secretRef:
          name: ${SECRET_GH_ORGANIZATION}-runner
      labels:
        - ${SETTING_CLUSTERNAME}
        - home-infra
      # dockerMTU: 1400
      env: []

---
# https://github.com/actions-runner-controller/actions-runner-controller#autoscaling
apiVersion: actions.summerwind.dev/v1alpha1
kind: HorizontalRunnerAutoscaler
metadata:
  name: ${SECRET_GH_ORGANIZATION}-runner
spec:
  scaleTargetRef:
    name: ${SECRET_GH_ORGANIZATION}-runner
  githubAPICredentialsFrom:
    secretRef:
      name: ${SECRET_GH_ORGANIZATION}-runner
    # Uncomment the below in case the target is not RunnerDeployment but RunnerSet
    # kind: RunnerSet
  scaleDownDelaySecondsAfterScaleOut: 300
  minReplicas: 1
  maxReplicas: 5
  metrics:
    - type: PercentageRunnersBusy
      scaleUpThreshold: "0.75" # The percentage of busy runners at which the number of desired runners are re-evaluated to scale up
      scaleDownThreshold: "0.3" # The percentage of busy runners at which the number of desired runners are re-evaluated to scale down
      scaleUpAdjustment: 2 # The scale up runner count added to desired count
      scaleDownAdjustment: 1 # The scale down runner count subtracted from the desired count

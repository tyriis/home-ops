---
# yaml-language-server: $schema=https://raw.githubusercontent.com/budimanjojo/talhelper/master/pkg/config/schemas/talconfig.json

# renovate: depName=ghcr.io/siderolabs/installer datasource=docker
talosVersion: v1.11.1
# renovate: depName=ghcr.io/siderolabs/kubelet datasource=docker
kubernetesVersion: v1.33.5

clusterName: kube-lab
endpoint: https://192.168.100.100:6443
domain: cluster.local
allowSchedulingOnMasters: true
allowSchedulingOnControlPlanes: true
cniConfig:
  name: none

nodes:
  # i9-13900H / 96GB / Samsung SSD 990 PRO 1TB / Samsung SSD 990 PRO 1TB
  - hostname: talos01
    ipAddress: 192.168.100.101
    controlPlane: true
    machineSpec:
      mode: metal
      arch: amd64
      useUKI: true
      secureboot: true
    installDiskSelector:
      # gen4 slot
      # serial: S6Z1NU0XA67084J
      # middle slot disk
      serial: S6Z1NU0XC22535P

    disableSearchDomain: true
    nameservers:
      # - 1.1.1.1
      # - 8.8.8.8
      # - 192.168.100.1
      - 192.168.1.1
    networkInterfaces:
      # 2.5GbE LAN
      - interface: enp89s0
        mtu: 1500
        dhcp: true
        vip:
          ip: 192.168.100.100
        # vlans:
        #   # IOT
        #   - vlanId: 10
        #     dhcp: false
        #     mtu: 1500
      # 2.5GbE NAS
      - interface: enp87s0
        mtu: 1500
        dhcp: true
      # 10GbE LAN
      - interface: bond0
        bond:
          deviceSelectors:
            - hardwareAddr: 58:47:ca:77:*
              driver: i40e
          mode: 802.3ad
          lacpRate: fast
          xmitHashPolicy: layer2
        mtu: 9000
        dhcp: false
        addresses:
          - 192.168.101.101/24
        routes:
          - network: 192.168.101.0/24
            gateway: 192.168.101.1
      # Thunderbolt
      - deviceSelector:
          busPath: 0-1.0 # talos02
        dhcp: false
        mtu: 65520
        addresses:
          - 169.254.255.101/32
        routes:
          - network: 169.254.255.102/32
            metric: 2048
      - deviceSelector:
          busPath: 1-1.0 # talos03
        dhcp: false
        mtu: 65520
        addresses:
          - 169.254.255.101/32
        routes:
          - network: 169.254.255.103/32
            metric: 2048
    nodeLabels:
      topology.kubernetes.io/zone: home-lab

  # i9-13900H / 96GB / Samsung SSD 990 PRO 1TB / Samsung SSD 990 PRO 1TB
  - hostname: talos02
    ipAddress: 192.168.100.102
    controlPlane: true
    machineSpec:
      mode: metal
      arch: amd64
      useUKI: true
      secureboot: true
    installDiskSelector:
      # gen4 slot
      # serial: S6Z1NJ0W384033R
      # middle slot disk
      serial: S7HDNF0Y440119F
    disableSearchDomain: true
    nameservers:
      # - 1.1.1.1
      # - 8.8.8.8
      # - 192.168.100.1
      - 192.168.1.1
    networkInterfaces:
      # 2.5GbE LAN
      - interface: enp89s0
        mtu: 1500
        dhcp: true
        vip:
          ip: 192.168.100.100
        # vlans:
        #   # IOT
        #   - vlanId: 10
        #     dhcp: false
        #     mtu: 1500
      # 2.5GbE NAS
      - interface: enp87s0
        mtu: 1500
        dhcp: true
      # 10GbE LAN
      - interface: bond0
        bond:
          deviceSelectors:
            - hardwareAddr: 58:47:ca:76:*
              driver: i40e
          mode: 802.3ad
          lacpRate: fast
          xmitHashPolicy: layer2
        mtu: 9000
        dhcp: false
        addresses:
          - 192.168.101.102/24
        routes:
          - network: 192.168.101.0/24
            gateway: 192.168.101.1
      # Thunderbolt
      - deviceSelector:
          busPath: 0-1.0 # talos01
        dhcp: false
        mtu: 65520
        addresses:
          - 169.254.255.102/32
        routes:
          - network: 169.254.255.101/32
            metric: 2048
      - deviceSelector:
          busPath: 1-1.0 # talos03
        dhcp: false
        mtu: 65520
        addresses:
          - 169.254.255.102/32
        routes:
          - network: 169.254.255.103/32
            metric: 2048
    nodeLabels:
      topology.kubernetes.io/zone: home-lab

  # i9-13900H / 96GB / Samsung SSD 990 PRO 1TB / Samsung SSD 990 PRO 1TB
  - hostname: talos03
    ipAddress: 192.168.100.103
    machineSpec:
      mode: metal
      arch: amd64
      useUKI: true
      secureboot: true
    controlPlane: true
    installDiskSelector:
      # gen4 slot
      # serial: S6Z1NJ0Y301566D
      # middle slot disk
      serial: S6Z1NJ0W534350X
    disableSearchDomain: true
    nameservers:
      # - 1.1.1.1
      # - 8.8.8.8
      # - 192.168.100.1
      - 192.168.1.1
    networkInterfaces:
      # 2.5GbE LAN
      - interface: enp89s0
        mtu: 1500
        dhcp: true
        vip:
          ip: 192.168.100.100
        # vlans:
        #   # IOT
        #   - vlanId: 10
        #     dhcp: false
        #     mtu: 1500
      # 2.5GbE NAS
      - interface: enp87s0
        mtu: 1500
        dhcp: true
      # 10GbE LAN
      - interface: bond0
        bond:
          deviceSelectors:
            - hardwareAddr: 58:47:ca:76:*
              driver: i40e
          mode: 802.3ad
          lacpRate: fast
          xmitHashPolicy: layer2
          miimon: 1000
        mtu: 9000
        dhcp: false
        addresses:
          - 192.168.101.103/24
        routes:
          - network: 192.168.101.0/24
            gateway: 192.168.101.1
      # Thunderbolt
      - deviceSelector:
          busPath: 0-1.0 # talos01
        dhcp: false
        mtu: 65520
        addresses:
          - 169.254.255.103/32
        routes:
          - network: 169.254.255.101/32
            metric: 2048
      - deviceSelector:
          busPath: 1-1.0 # talos02
        dhcp: false
        mtu: 65520
        addresses:
          - 169.254.255.103/32
        routes:
          - network: 169.254.255.102/32
            metric: 2048
    nodeLabels:
      topology.kubernetes.io/zone: home-lab

controlPlane:
  schematic:
    customization:
      systemExtensions:
        officialExtensions:
          - siderolabs/i915
          - siderolabs/intel-ucode
          - siderolabs/thunderbolt
      extraKernelArgs:
        - apparmor=0 # Less security, faster puter
        - init_on_alloc=0 # Less security, faster puter
        - init_on_free=0 # Less security, faster puter
        - intel_iommu=on # PCI Passthrough
        - iommu=pt # PCI Passthrough
        - mitigations=off # Less security, faster puter
        - security=none # Less security, faster puter
        - talos.auditd.disabled=1 # Less security, faster puter

  patches:
    - |-
      machine:
        kernel:
          modules:
            - name: thunderbolt
            - name: thunderbolt_net
        udev:
          rules:
            - ACTION=="add", SUBSYSTEM=="thunderbolt", ATTR{authorized}=="0", ATTR{authorized}="1"

        kubelet:
          extraArgs:
            rotate-server-certificates: "true"
          extraMounts:
            - destination: /var/mnt/extra
              type: bind
              source: /var/mnt/extra
              options:
                - rbind
                - rw
                - rshared
          extraConfig:
            allowedUnsafeSysctls:
              - net.ipv6.conf.net1.*  # IPv6 syscalls for Matter/Thread
            serializeImagePulls: false
          defaultRuntimeSeccompProfileEnabled: true
          nodeIP:
            validSubnets: ["192.168.100.0/24"]
          disableManifestsDirectory: true
        files:
          - op: create
            path: /etc/cri/conf.d/20-customization.part
            content: |
              [plugins]
                [plugins."io.containerd.grpc.v1.cri"]
                  enable_unprivileged_ports = true
                  enable_unprivileged_icmp = true
              [plugins."io.containerd.cri.v1.images"]
                discard_unpacked_layers = false
              [plugins."io.containerd.cri.v1.runtime"]
                device_ownership_from_security_context = true
          - op: overwrite
            path: /etc/nfsmount.conf
            permissions: 0o644
            content: |
              [ NFSMount_Global_Options ]
              nfsvers=4.1
              hard=True
              nconnect=8
              noatime=True
              rsize=1048576
              wsize=1048576

        sysctls:
          fs.inotify.max_user_watches: 1048576   # Watchdog
          fs.inotify.max_user_instances: 8192    # Watchdog
          net.core.default_qdisc: fq             # 10Gb/s
          net.core.rmem_max: 67108864            # 10Gb/s | Cloudflared / QUIC
          net.core.wmem_max: 67108864            # 10Gb/s | Cloudflared / QUIC
          net.ipv4.tcp_congestion_control: bbr   # 10Gb/s
          net.ipv4.tcp_fastopen: 3               # Send and accept data in the opening SYN packet
          net.ipv4.tcp_mtu_probing: 1            # 10Gb/s | Jumbo frames
          net.ipv4.tcp_rmem: 4096 87380 33554432 # 10Gb/s
          net.ipv4.tcp_wmem: 4096 65536 33554432 # 10Gb/s
          net.ipv4.tcp_window_scaling: 1         # 10Gb/s
          vm.nr_hugepages: 1024                  # PostgreSQL
        sysfs:
          devices.system.cpu.intel_pstate.hwp_dynamic_boost: 1
          devices.system.cpu.cpu0.cpuidle.state1.disable: 1
          devices.system.cpu.cpu0.cpuidle.state2.disable: 1
          devices.system.cpu.cpu0.cpuidle.state3.disable: 1
        time:
          disabled: false
          servers:
            - 192.168.1.1
            - time.cloudflare.com
        registries:
          mirrors:
            docker.io:
              endpoints:
                - https://harbor.tyriis.dev/v2/proxy-docker.io
              overridePath: true
            ghcr.io:
              endpoints:
                - https://harbor.tyriis.dev/v2/proxy-ghcr.io
              overridePath: true
            quay.io:
              endpoints:
                - https://harbor.tyriis.dev/v2/proxy-quay.io
              overridePath: true
        features:
          rbac: true
          stableHostname: true
          kubernetesTalosAPIAccess:
            enabled: true
            allowedRoles:
              - os:admin
            allowedKubernetesNamespaces:
              - system-upgrade
          apidCheckExtKeyUsage: true
          diskQuotaSupport: true
          kubePrism:
            enabled: true
            port: 7445
          hostDNS:
            enabled: true
            resolveMemberNames: true
            forwardKubeDNSToHost: false

      cluster:
        etcd:
          extraArgs:
            listen-metrics-urls: http://0.0.0.0:2381
        controllerManager:
          extraArgs:
            bind-address: 0.0.0.0
        proxy:
          disabled: true
        coreDNS:
          disabled: true
        discovery:
          enabled: true
          registries:
            kubernetes:
              disabled: true
            service:
              disabled: false
        apiServer:
          extraArgs:
            runtime-config: admissionregistration.k8s.io/v1alpha1=true
            feature-gates: MutatingAdmissionPolicy=true
        scheduler:
          extraArgs:
            bind-address: 0.0.0.0
          config:
            apiVersion: kubescheduler.config.k8s.io/v1
            kind: KubeSchedulerConfiguration
            profiles:
              - schedulerName: default-scheduler
                plugins:
                  score:
                    disabled:
                      - name: ImageLocality
                pluginConfig:
                  - name: PodTopologySpread
                    args:
                      defaultingType: List
                      defaultConstraints:
                        - maxSkew: 1
                          topologyKey: kubernetes.io/hostname
                          whenUnsatisfiable: ScheduleAnyway
        extraManifests:
          - https://github.com/kubernetes-sigs/gateway-api/releases/download/v1.3.0/experimental-install.yaml
          - https://github.com/prometheus-operator/prometheus-operator/releases/download/v0.85.0/stripped-down-crds.yaml

---
# yaml-language-server: $schema=https://raw.githubusercontent.com/budimanjojo/talhelper/master/pkg/config/schemas/talconfig.json

# renovate: depName=ghcr.io/siderolabs/installer datasource=docker
talosVersion: v1.11.3
# renovate: depName=ghcr.io/siderolabs/kubelet datasource=docker
kubernetesVersion: v1.34.1

clusterName: kube-nas
endpoint: https://192.168.100.90:6443
domain: cluster.local
allowSchedulingOnMasters: true
allowSchedulingOnControlPlanes: true
cniConfig:
  name: none

nodes:
  # N100 / 32 GB / Samsung SSD 990 PRO 1TB / Samsung SSD 870 500G
  - hostname: nas01
    ipAddress: 192.168.100.90
    controlPlane: true
    machineSpec:
      mode: metal
      arch: amd64
      useUKI: true
      secureboot: false
    installDiskSelector:
      serial: S7HDNJ0Y842605L

    disableSearchDomain: true
    nameservers:
      # - 1.1.1.1
      # - 8.8.8.8
      # - 192.168.100.1
      - 192.168.1.1
    networkInterfaces:
      # 2.5GbE LAN
      - interface: enp2s0
        mtu: 1500
        dhcp: true
      # 2.5GbE LAN
      - interface: enp3s0
        mtu: 1500
        dhcp: true
    nodeLabels:
      topology.kubernetes.io/zone: home-lab

controlPlane:
  schematic:
    customization:
      systemExtensions:
        officialExtensions:
          - siderolabs/intel-ucode
          - siderolabs/nfsd
          - siderolabs/nvme-cli
          - siderolabs/zfs
      extraKernelArgs:
        - apparmor=0 # Less security, faster puter
        - init_on_alloc=0 # Less security, faster puter
        - init_on_free=0 # Less security, faster puter
        - intel_iommu=on # PCI Passthrough
        - iommu=pt # PCI Passthrough
        - mitigations=off # Less security, faster puter
        - security=none # Less security, faster puter
        - talos.auditd.disabled=1 # Less security, faster puter

  patches:
    - |-
      machine:
        kernel:
          modules:
            - name: zfs
        kubelet:
          extraArgs:
            rotate-server-certificates: "true"
          extraMounts:
            - destination: /var/mnt/extra
              type: bind
              source: /var/mnt/extra
              options:
                - rbind
                - rw
                - rshared
          extraConfig:
            serializeImagePulls: false
          defaultRuntimeSeccompProfileEnabled: false
          nodeIP:
            validSubnets: ["192.168.100.0/24"]
          disableManifestsDirectory: true
        files:
          - op: create
            path: /etc/cri/conf.d/20-customization.part
            content: |
              [plugins]
                [plugins."io.containerd.grpc.v1.cri"]
                  enable_unprivileged_ports = true
                  enable_unprivileged_icmp = true
              [plugins."io.containerd.cri.v1.images"]
                discard_unpacked_layers = false
              [plugins."io.containerd.cri.v1.runtime"]
                device_ownership_from_security_context = true
          - op: overwrite
            path: /etc/nfsmount.conf
            permissions: 0o644
            content: |
              [ NFSMount_Global_Options ]
              nfsvers=4.1
              hard=True
              nconnect=8
              noatime=True
              rsize=1048576
              wsize=1048576

        sysctls:
          fs.inotify.max_user_watches: 1048576   # Watchdog
          fs.inotify.max_user_instances: 8192    # Watchdog
          net.ipv4.tcp_fastopen: 3               # Send and accept data in the opening SYN packet
          net.ipv4.tcp_mtu_probing: 1            # Jumbo frames
          vm.nr_hugepages: 1024                  # PostgreSQL
        time:
          disabled: false
          servers:
            - 192.168.1.1
            - time.cloudflare.com
        features:
          rbac: true
          stableHostname: true
          kubernetesTalosAPIAccess:
            enabled: true
            allowedRoles:
              - os:admin
            allowedKubernetesNamespaces:
              - system-upgrade
          apidCheckExtKeyUsage: true
          diskQuotaSupport: true
          kubePrism:
            enabled: true
            port: 7445
          hostDNS:
            enabled: true
            resolveMemberNames: true
            forwardKubeDNSToHost: false

      cluster:
        etcd:
          extraArgs:
            listen-metrics-urls: http://0.0.0.0:2381
        controllerManager:
          extraArgs:
            bind-address: 0.0.0.0
        proxy:
          disabled: true
        coreDNS:
          disabled: true
        discovery:
          enabled: true
          registries:
            kubernetes:
              disabled: true
            service:
              disabled: false
        scheduler:
          extraArgs:
            bind-address: 0.0.0.0
        extraManifests:
          - https://github.com/kubernetes-sigs/gateway-api/releases/download/v1.4.0/experimental-install.yaml
          - https://github.com/prometheus-operator/prometheus-operator/releases/download/v0.86.1/stripped-down-crds.yaml

---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

vars:
  KUBE_VERSION:
    sh: grep '^kubectl = ' {{.ROOT_DIR}}/.mise.toml | cut -d'"' -f2

tasks:
  flux-local:
    desc: run flux-local test
    internal: true
    cmds:
      - test -d .venv || uv venv
      - uv pip list | grep -q flux-local || uv pip install flux-local
      - |
        uv run flux-local test \
          --kube-version {{.KUBE_VERSION}} \
          --all-namespaces \
          --path {{.KUBERNETES_DIR}}/kube-{{.CLI_ARGS}}/flux \
          --enable-helm \
          --verbose

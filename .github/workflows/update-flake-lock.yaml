---
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: update-flake-lock

on:
  workflow_dispatch:
  # schedule:
  #   - cron: '37 0 * * *'

permissions:
  actions: write
  contents: write
  pull-requests: write

jobs:
  lockfile:
    runs-on: ubuntu-latest
    steps:
      # https://github.com/marketplace/actions/create-github-app-token
      - name: Generate Token
        uses: actions/create-github-app-token@30bf6253fa41bdc8d1501d202ad15287582246b4 # v2.0.3
        # if: ${{ github.event.pull_request.head.repo.full_name == github.repository }}
        id: app-token
        with:
          app-id: ${{ secrets.BOT_APP_ID }}
          private-key: ${{ secrets.BOT_APP_PRIVATE_KEY }}

      # https://github.com/marketplace/actions/checkout
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          token: "${{ steps.app-token.outputs.token }}"

      # https://github.com/marketplace/actions/the-determinate-nix-installer
      - name: Install nix
        uses: DeterminateSystems/nix-installer-action@21a544727d0c62386e78b4befe52d19ad12692e3 # v17

      # https://github.com/marketplace/actions/magic-nix-cache
      - name: Use cache
        uses: DeterminateSystems/magic-nix-cache-action@6221693898146dc97e38ad0e013488a16477a4c4 # v9

      # https://github.com/marketplace/actions/update-nix-flake-lock
      - name: Update flake.lock
        id: update
        uses: DeterminateSystems/update-flake-lock@a2bbe0274e3a0c4194390a1e445f734c597ebc37 # v24
        with:
          path-to-flake-dir: infra/nixos
          token: ${{ steps.app-token.outputs.token }}

      # - name: Enable automerge
      #   if: ${{ steps.update.outputs.pull-request-number != '' }}
      #   run: gh pr merge --squash --auto ${{ steps.update.outputs.pull-request-number }}
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: diff
        run: git diff
